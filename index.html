<!DOCTYPE html>
<html>
<body>

<canvas id="incidence" width="500" height="150" style="border:1px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.</canvas>

<canvas id="hauteur" width="500" height="150" style="border:1px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.</canvas>

</body>
<script>
"use strict";
function cosD(a) {
	return Math.cos(a * Math.PI / 180);
}
function sinD(a) {
	return Math.sin(a * Math.PI / 180);
}
function applyOneTurn(plane, dt) {
    plane.vz = plane.v * sinD(plane.p);
    plane.vx = plane.v * cosD(plane.p);
    plane.z = plane.z + plane.vz * dt;
    plane.x = plane.x + plane.vx * dt;
	plane.Cx = 0.0005 * (plane.i - 3) ** 2 + 0.01;
	plane.Cz = (plane.i + 1 ) / 20;
	plane.Rx = plane.K0 * plane.Cx * plane.v * plane.v;
	plane.Rz = plane.K0 * plane.Cz * plane.v * plane.v;
	if (plane.z<0) {
		plane.vz = -plane.z / dt;
		plane.z = 0
	}
	plane.vz = plane.vz + ((plane.Rx - plane.T) * sinD(plane.p) + plane.Rz * cosD(plane.p) - plane.W) / plane.m * dt;
	plane.vx = plane.vx - ((plane.Rx - plane.T) * cosD(plane.p) + plane.Rz * sinD(plane.p)) / plane.m * dt;
	plane.v = Math.sqrt( plane.vx ** 2 + plane.vz ** 2);
	plane.p = Math.atan2(plane.vz, plane.vx) * 180 / Math.PI;
}

function Plane() {
	// h: m, vz: 300ft/min=1.524 m/s, vp: 65kt=33.44 m/s, W: N=kg*m/s/s
	this.z = 10; // m
	this.x = 0; // m
	this.v = 34; // m/s ~ 65 kt
	this.p = -3; // 3Â° is the perfect approach
	this.m = 500; //kg
	this.W = this.m * 9.81; // Flying on earth
	this.i = 0;
	this.K0 = this.W * 20 / this.v / this.v; // Stable: lift=weight and i is approx 0
	this.T = this.K0 * 0.012 * this.v * this.v; // Stable: traction=Rx
	this.toString = () => {
		return "x="+this.x.toFixed(4)
		        +",z="+this.z.toFixed(4)
		        +",Cx="+this.Cx.toFixed(4)
		        +",Cz="+this.Cz.toFixed(4)
		        +",Vx="+this.vx.toFixed(4)
		        +",Vz="+this.vz.toFixed(4)
		        +",i="+this.i.toFixed(4)
		        +",p="+this.p.toFixed(4);
	}
}

var acft = new Plane();
// 1.3Vs0 to 1.1Vs0 in 5 sec.
// T = Kx * vp * vp = 0.2 * vp / 1.3 / 5 <=> Kx = 0.2 / 1.3 / 5 / vp

var c = document.getElementById("incidence");
var gdIncidence = c.getContext("2d");
gdIncidence.beginPath();
c = document.getElementById("hauteur");
var gdHauteur = c.getContext("2d");
gdHauteur.beginPath();
gdHauteur.strokeStyle="#FF0000";
gdHauteur.moveTo(0,100);
gdHauteur.lineTo(300,100);
gdHauteur.stroke();
gdHauteur.beginPath();
gdHauteur.strokeStyle="#00FF00";
gdHauteur.moveTo(0,85);
gdHauteur.lineTo(300,85);
gdHauteur.stroke();
gdHauteur.beginPath();
gdHauteur.strokeStyle="#000000";
var intervalMS = 20;
var t = 0;
navigator.getGamepads()[0];
var intID = setInterval( () => {
	var joystick = navigator.getGamepads()[0];
	if (joystick == null) {
		if (acft.z > 1.5) {
		    // Maintain P=W
		    acft.i = acft.W / acft.v / acft.v / acft.K0 * 20 - 1;
		} else if (acft.T > 0) {
			acft.T = 0;
		} else if (acft.vz < - 0.5) {
			acft.i = acft.W / acft.v / acft.v / acft.K0 * 1.3 * 20 - 1;
		} else if (acft.vz < 0) {
			acft.i = acft.W / acft.v / acft.v / acft.K0 * 1.1 * 20 - 1;
		} else {
			acft.i = acft.W / acft.v / acft.v / acft.K0 * 20 - 1;
		}
	} else {
		var stick = joystick.axes[1];
		if (t == 0 && !joystick.buttons[4].pressed) {
			return
		}
		acft.i = stick / 2;
		if (joystick.buttons[13].pressed && acft.T > 0) {
			// Power down
			acft.T = 0;
		}
	}
	t++;
	applyOneTurn(acft, intervalMS / 1000);

	console.log(acft.toString());
	gdIncidence.lineTo(t, acft.i * 100);
	gdIncidence.stroke();
	gdHauteur.lineTo(acft.x, 100 - acft.z * 10);
	gdHauteur.stroke();
	if (t === 500) {
		clearInterval(intID);
	}
}, intervalMS);    
</script>

</html>

